<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Expression Calculator</title>
  <script src="js/math.min.js"></script>
</head>



<script type="text/javascript">

math.config({ number: 'BigNumber', precision: 128 });

function log_message(txt) {
    console.log(txt);
}

function init() {

    var text_input = document.getElementById("text_input");
    onKeyPress(text_input);
   
}


function formatBinary(v) {

    if (v.startsWith("0b") || v.startsWith("0b"))
    {
        v = v.substring(2);
    }

    log_message("L:" + v.length);
    var paddingZeroesNum = 8 - (v.length % 8);
    if (paddingZeroesNum == 8) {
        paddingZeroesNum = 0;
    }
    log_message("P:" + paddingZeroesNum);
    v = "0".repeat(paddingZeroesNum) + v;

    var spansCount = Math.floor(v.length / 8);
    var v1 = "";
    for(var i = 0; i < spansCount; i++)
    {
        if (i & 1) {
            v1 = v1 + '<span class="odd">'  + v.substring(i*8, i*8+8) + '</span>';
        } else {
            v1 = v1 + '<span class="even">'  + v.substring(i*8, i*8+8) + '</span>';
        }
    }

    v = v1 + "b";
    return v;
}

function formatHex(v) {

    if (v.startsWith("0x") || v.startsWith("0X"))
    {
        v = v.substring(2);
    }

    log_message(v.length);
    var paddingZeroesNum = 2 - (v.length % 2);
    if (paddingZeroesNum == 2) {
        paddingZeroesNum = 0;
    }
    log_message(paddingZeroesNum);
    v = "0".repeat(paddingZeroesNum) + v;

    var spansCount = Math.floor(v.length / 2);
    var v1 = "";
    for(var i = 0; i < spansCount; i++)
    {
        if (i & 1) {
            v1 = v1 + '<span class="odd">'  + v.substring(i*2, i*2+2) + '</span>';
        } else {
            v1 = v1 + '<span class="even">'  + v.substring(i*2, i*2+2) + '</span>';
        }
    }


    v = "0x" + v1;
    return v;
}

function byteToHex(b) {
    var r = b.toString(16);
    if (r.length == 1) {
        r = "0" + r;
    }
    return r;
}

function is_dec_digit(chr) {
    if (chr == "0" || chr == "1" || chr == "2" ||
        chr == "3" || chr == "4" || chr == "5" ||
        chr == "6" || chr == "7" || chr == "8" ||
        chr == "9") {
            return true;
    }
    return false;
}

function is_hex_digit(chr) {
    if (is_dec_digit(chr) ||
        chr == "a" || chr == "A" ||
        chr == "b" || chr == "B" ||
        chr == "c" || chr == "C" ||
        chr == "d" || chr == "D" ||
        chr == "e" || chr == "E" ||
        chr == "f" || chr == "F") {
            return true;
    }
    return false;
}

function is_binary_number(str) {
    for(var i = 0; i < str.length; i++) {
        var chr = str.charAt(i);
        if (chr != "0" && chr != "1") {
            return false;
        }
    }
    return true;
}

function preprocessString(text) {
    var res = [];
    var num = ""
    var is_hex = false;
    for(var i = 0; i < text.length; i++) {
        var chr = text.charAt(i);

        var j = (i + 1);
        if (j < text.length) {
            var nextChr = text.charAt(j);
            if (num.length == 0 && chr == "0" && 
                (nextChr == "x" || nextChr == "X"))
            {
                is_hex = true;
                //num = "0x";
                i+=1;
                continue;
            }
        }

        var is_digit = is_hex ? is_hex_digit(chr) : is_dec_digit(chr); 
        if (!is_digit) {
            if (num && num.length > 0) {
                var base = is_hex ? 16 : 10;
                if (chr == "b" && is_binary_number(num)) {
                    base = 2;
                    chr = null;
                }
                if (base != 10) {
                    log_message("parse(" + num + ", " + base + ")");
                    var dec_num = parseInt(num, base);
                    res.push(dec_num);
                } else {
                    res.push(num);
                }
                
                num = "";
                is_hex = false;
            }

            if (chr) {
                res.push(chr);
            }
        } else {
            num += chr;
        }
    }

    if (num && num.length > 0) {
        var base = is_hex ? 16 : 10;
        if (chr == "b" && is_binary_number(num)) {
            base = 2;
            chr = null;
        }
        if (base != 10) {
            log_message("parse(" + num + ", " + base + ")");
            var dec_num = parseInt(num, base);
            res.push(dec_num);
        } else {
            res.push(num);
        }
        num = "";
        is_hex = false;
    }

    // convert back to string
    var result = "";
    for(var i = 0; i < res.length; i++) {
        result += res[i];
    }

    // http://mathjs.org/docs/expressions/syntax.html
    // replace pow (^) to bitwise xor (^|)
    result = result.replace("^", "^|");

    return result;
}


function onKeyPress(element) {
    var text = preprocessString(element.value);

    log_message("in: " + text);

// reference UI
// http://farplugs.sourceforge.net/img/codercalc.png
//
// have to replace 0xff and 01111b to regular numbers
// http://mathjs.org/docs/reference/constants.html
//
// IEEE 754
// https://www.h-schmidt.net/FloatConverter/IEEE754.html

    var dout = document.getElementById("dec_out");

    var bout = document.getElementById("bin_out");
    var hout = document.getElementById("hex_out");
    var aout = document.getElementById("ascii_out");
    var fout = document.getElementById("ieee_out");
    var fout_f = document.getElementById("ieee_out_f");
    var fout_s = document.getElementById("ieee_out_s");
    var fout_e = document.getElementById("ieee_out_e");
    var fout_m = document.getElementById("ieee_out_m");
    

    bout.innerHTML = "N/A";
    hout.innerHTML = "N/A";
    aout.innerHTML = "N/A";
    fout.innerHTML = "N/A";
    fout_f.innerHTML = "N/A";
    fout_s.innerHTML = "N/A";
    fout_e.innerHTML = "N/A";
    fout_m.innerHTML = "N/A";

    try {
        var res = math.eval(text);
    }

    catch(err) {
        log_message("err: '" + err.message + "'");
        dout.innerHTML = err.message;
        return;
    }

    if (res)
    {
        log_message("e: '" + text + "'");
        log_message("r: '" + res + "'");

        try {

            var bigres = math.bignumber(res);
            var big_31 = math.bignumber(31);
            var big_128 = math.bignumber(128);

        //https://unpkg.com/mathjs@5.4.1/dist/math.js
            bout.innerHTML = formatBinary(bigres.floor().toBinary());
            hout.innerHTML = formatHex(bigres.floor().toHexadecimal());
            dout.innerHTML = math.format(bigres, {notation: "fixed"});

            if (bigres.greaterThan(big_31) && bigres.lessThan(big_128)) {
                var ascii = String.fromCharCode(bigres.floor().toNumber());
                aout.innerHTML = ascii;
            } else {
                aout.innerHTML = "?";
            }


            var dbl = bigres.toNumber();
            var flt = Math.fround(dbl);

            var bytes = new Uint8Array(4);
            new DataView(bytes.buffer).setFloat32(0, flt);

            log_message(bytes);

            fout_f.innerHTML = flt.toString();

            var hexStr = byteToHex(bytes[0]) + byteToHex(bytes[1]) + byteToHex(bytes[2]) + byteToHex(bytes[3]);
            fout.innerHTML = formatHex(hexStr);
            
            var fltHex = parseInt(hexStr, 16);
            var sign = (fltHex >> 31) & 1;
            var exp = (fltHex & 0x7f800000) >> 23;
            var mantisa = (fltHex & 0x007fffff);

            fout_s.innerHTML = sign;
            fout_e.innerHTML = exp;
            fout_m.innerHTML = mantisa;
        }
        catch(err) {
            dout.innerHTML = res;
        }


    } else
    {
        dout.innerHTML = "No result";
    }
}



</script>


<style type="text/css" media="screen">

body {
    background-color: #000080;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', 'source-code-pro', monospace;
	font-size: 16px;
    color: #ffff00;
	font-style: normal;
    font-variant: normal;
}

input{
    background-color: #008080;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', 'source-code-pro', monospace;
	font-size: 16px;
    color: #c0c0c0;
	font-style: normal;
    font-variant: normal;
}

table {
    background-color: #c0c0c0;
    color: #000000;
}

.white {
    color: #ffffff;
}

.odd {
   color: #000000;
}

.even {
   color: #505050;
}


</style>

<body onload="init();">

<div>


    <table>
            <tr>
                <td>
                    <input id=text_input type="text" size="100" oninput="onKeyPress(this)">
                </td>
            </tr>
            <tr>
                <td>

                    <table>
                        <tr>
                            <td><span class="white">Result</span></td>
                            <td id=dec_out>-</td>
                        </tr>
                        <tr>
                            <td><span class="white">Hex</span></td>
                            <td id=hex_out>-</td>
                        </tr>
                        <tr>
                            <td><span class="white">Bin</span></td>
                            <td id=bin_out>-</td>
                        </tr>
                        <tr>
                            <td><span class="white">Ascii</span></td>
                            <td id=ascii_out>-</td>
                        </tr>
                        <tr>
                            <td><span class="white">IEEE 754</span></td>
                            <td id=ieee_out_f>-</td>
                        </tr>
                        <tr>
                            <td><span class="white">IEEE 754 (hex)</span></td>
                            <td id=ieee_out>-</td>
                        </tr>
                        <tr>
                            <td><span class="white">Sign</span></td>
                            <td id=ieee_out_s>-</td>
                        </tr>
                        <tr>
                            <td><span class="white">Exponent</span></td>
                            <td id=ieee_out_e>-</td>
                        </tr>
                        <tr>
                            <td><span class="white">Mantisa</span></td>
                            <td id=ieee_out_m>-</td>
                        </tr>
                    </table>

                </td>
            </tr>
        </table>


</div>

</body>
</html>